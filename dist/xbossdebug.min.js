!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.XbossDebug=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},a={typeDecide:function(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"},isFunction:function(e){return a.typeDecide(e,"Function")},isString:function(e){return a.typeDecide(e,"String")},serializeObj:function(e){var t="";return Object.keys(e).forEach(function(r){a.typeDecide(e[r],"Object")?t+=r+"="+a.stringify(e[r]):t+=r+"="+e[r]+"^"}),encodeURIComponent(t.substr(0,t.length-1))},stringify:function(t){if(window.JSON&&window.JSON.stringify)return JSON.stringify(t);var r=void 0===t?"undefined":e(t);if("object"!=r||null===t)return"string"==r&&(t='"'+t+'"'),String(t);var n,o,i=[],a=t&&t.constructor==Array,u=arguments.callee;for(n in t)t.hasOwnProperty(n)&&(r=void 0===(o=t[n])?"undefined":e(o),t.hasOwnProperty(n)&&("string"==r?o='"'+o+'"':"object"==r&&null!==o&&(o=u(o)),i.push((a?"":'"'+n+'":')+String(o))));return(a?"[":"{")+String(i)+(a?"]":"}")},parse:function(e){return window.JSON&&window.JSON.parse?JSON.parse(e):new Function("return "+e)()},getServerPort:function(){return""===window.location.port?"http:"===window.location.protocol?"80":"443":window.location.port},getUserAgent:function(){return window.navigator.userAgent},getPlatType:function(){try{return document.createEvent("TouchEvent"),"Mobile"}catch(e){return"PC"}},flashVer:function(){var e="-",t=navigator,r=void 0;if(t.plugins&&t.plugins.length){for(r=0;r<t.plugins.length;r++)if(-1!==t.plugins[r].name.indexOf("Shockwave Flash")){e=t.plugins[r].description.split("Shockwave Flash ")[1];break}}else if(window.ActiveXObject)for(r=10;r>=2;r--)try{if(new Function("return new ActiveXObject('ShockwaveFlash.ShockwaveFlash."+r+"');")()){e=r+".0";break}}catch(e){}return e},stringSplice:function(e,t,r,n){if(""===e)return"";t+=n=""===n?"=":n;var o=e.indexOf(t);if(o<0)return"";var i=i<(o+=t.length)?e.length:e.indexOf(r,o);return e.substring(o,i)},getReferer:function(){var e=document.referrer.toLowerCase();return""!==e&&!e.match(/^[^\?&#]*.swf([\?#])?/)||(e=a.stringSplice(window.location.href,"ref","&","")),encodeURIComponent(e)},getSystemParams:function(){var e=window.screen;return{userAgent:a.getUserAgent(),currentUrl:window.location.href,timestamp:+new Date+Math.random(),projectType:a.getPlatType(),flashVer:a.flashVer(),title:document.title,screenSize:e.width+"x"+e.height,referer:location.hostname?location.hostname:"",host:window.location.protocol+"//"+window.location.hostname}},toArray:function(e){return Array.prototype.slice.call(e)},getCookie:function(e){for(var t=document.cookie.split("; "),r="",n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e){r=o[1];break}}return r},addCookie:function(e,t,r){var n=new Date;return n.setDate(n.getDate()+(r||365)),document.cookie=e+"="+t+"; expires="+n.toGMTString(),a.getCookie(e)},noop:function(){},clearCookie:function(e){return a.addCookie(e,"",-1),a.getCookie(e)},assignObject:function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e},getErrorInfo:function(e){if(void 0!==e.stack&&e.stack){var t,r,n,o=e.stack.split("\n");/^(.*) is undefined$/.exec(e.message);if(r=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i.exec(o[1])){var a=r[2]&&0===r[2].indexOf("native");r[2]&&0===r[2].indexOf("eval")&&(t=/\((\S*)(?::(\d+))(?::(\d+))\)/.exec(r[2]))&&(r[2]=t[1],r[3]=t[2],r[4]=t[3]),n={url:a?null:r[2],line:r[3]?+r[3]:null,column:r[4]?+r[4]:null}}else if(r=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i.exec(o[1]))n={url:r[2],line:+r[3],column:r[4]?+r[4]:null};else if(r=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i.exec(o[1])){r[3]&&r[3].indexOf(" > eval")>-1&&(t=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i.exec(r[3]))?(r[3]=t[1],r[4]=t[2],r[5]=null):0!==i||r[5]||void 0===e.columnNumber||([][0].column=e.columnNumber+1),n={url:r[3],line:r[4]?+r[4]:null,column:r[5]?+r[5]:null}}return{msg:e.name+":"+e.message,rowNum:n.line,colNum:n.column,targetUrl:n.url,level:4}}return{msg:e.name+":"+e.message,level:4}},handleAddListener:function(e,t){window.addEventListener?window.addEventListener(e,t):window.attachEvent("on"+e,t)}},u=function(){function e(r){t(this,e),this.config={key:"",proxyAll:!1,mergeReport:!0,delay:1e3,url:"http://debug.limesoftware.cn/read.gif",except:[/^Script error\.?/,/^Javascript error: Script error\.? on line 0/],random:1,repeat:5,errorLSSign:"mx-error",maxErrorCookieNo:20,validTime:7},this.config=a.assignObject(this.config,r)}return r(e,[{key:"get",value:function(e){return this.config[e]}},{key:"set",value:function(e,t){return this.config[e]=t,this.config[e]}}]),e}(),c=!!window.localStorage;function s(e,t){return c?e:t}function l(e,t,r){return e.apply(r,t)}var f,d={getKey:function(e){var t=function(t){return e[t]};return["msg","colNum","rowNum"].filter(t).map(t).join("@")},deleteExpiresItem:function(e){var t=e?a.parse(e):{},r=+new Date;for(var n in t)t[n].expiresTime<=r&&delete t[n];return t},getEpires:function(e){return+new Date+864e5*e},limitError:function(e,t){var r=Object.keys(e);return r.length>=t&&delete e[r[0]],e},setInfo:function(e,t,r,n){var o=d.getItem(e);if(t){var i=d.getKey(t);(o=this.limitError(o,n))[i]={expiresTime:d.getEpires(r),value:t.msg}}return a.stringify(o)},setItem:s(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];localStorage.setItem(t[0],l(d.setInfo,t,d))},function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];a.addCookie(t[0],l(d.setInfo,t,d))}),getItem:s(function(e){return d.deleteExpiresItem(localStorage.getItem(e))},function(e){return d.deleteExpiresItem(a.getCookie(e))}),clear:s(function(e){return e?localStorage.removeItem(e):localStorage.clear()},function(e){return e?a.clearCookie(e):document.cookie.split("; ").forEach(a.clearCookie)})},h=function(e){function i(e){t(this,i);var r=o(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return r._storeClickedDom=function(e){var t=e.target?e.target:e.srcElement,n={time:(new Date).getTime()};if(t){if(t.tagName&&(n.tagName=t.tagName),t.id&&(n.id=t.id),t.className&&(n.className=t.className),t.name&&(n.name=t.name),!t.id){for(var o=0,i=t;o++<3&&i.parentNode&&i.parentNode.outerHTML&&!(i=i.parentNode).id;);if(i.id)n.parentId=o+":"+i.id;else{var a=i.outerHTML.replace(/>\s+</g,"><");a&&a.length>200&&(a=a.slice(0,200)),n.outerHTML=a}}r.breadcrumbs.push(n),r.breadcrumbs.length>10&&r.breadcrumbs.shift()}},r._getTiming=function(){var e=performance.timing,t={};(e.loadEventEnd-e.loadEventStart)/1e3<0?setTimeout(function(){r._getTiming()},200):(t.request=e.responseEnd-e.requestStart,t.domrender=e.domComplete-e.domInteractive,t.fp=e.responseStart-e.navigationStart,t.domready=e.domContentLoadedEventEnd-e.navigationStart,t.onload=e.loadEventEnd-e.navigationStart,t.fmp=parseInt(performance.getEntriesByType("paint")[0].startTime),t.TTI=e.domInteractive-e.requestStart,r.reportPerformance(t))},r.breadcrumbs=[],r.rewriteError(),r.rewritePromiseError(),r.catchClickQueue(),setTimeout(function(){r.catchPerformance()},1e3),r}return n(i,e),r(i,[{key:"rewriteError",value:function(){var e=this,t=arguments,r=window.onerror||a.noop;window.onerror=function(n,o,i,u,c){if(u=u||window.event&&window.event.errorCharacter||0,!e.trigger("error",a.toArray(t)))return!1;var s=n;s=c&&c.stack?e.handleErrorStack(c):e._fixMsgByCaller(s,t.callee.caller),a.typeDecide(s,"Event")&&(s+=s.type?"--"+s.type+"--"+(s.target?s.target.tagName+"::"+s.target.src:""):""),s&&e.error({msg:s,rowNum:i,colNum:u,targetUrl:o,level:4,breadcrumbs:JSON.stringify(e.breadcrumbs)}),r.call(null,n,o,i,u,c)}}},{key:"rewritePromiseError",value:function(){var e=this,t=arguments,r=window.onunhandledrejection||a.noop;window.onunhandledrejection=function(n){if(!e.trigger("error",a.toArray(t)))return!1;var o=n.reason&&n.reason.message||"",i={};n.reason&&n.reason.stack?(o=e.handleErrorStack(n.reason),i=e._parseErrorStack(n.reason.stack)):o=e._fixMsgByCaller(o,t.callee.caller),o&&e.error({msg:o,rowNum:i.line||0,colNum:i.col||0,targetUrl:i.targetUrl||"",level:4,breadcrumbs:JSON.stringify(e.breadcrumbs)}),r.call(null,n)}}},{key:"handleErrorStack",value:function(e){var t=e.stack,r=e.toString();return r?-1===t.indexOf(r)&&(t+="@"+r):t="",t}},{key:"_fixMsgByCaller",value:function(e,t){for(var r=[],n=t,o=3;n&&o-- >0&&(r.push(n.toString()),n!==n.caller);)n=n.caller;return r.length>0&&(e+="@"+r.join(",")),e}},{key:"_parseErrorStack",value:function(e){var t={},r=e.split("at")[1].match(/http.*/)[0].replace(/\)$/,"").split(":"),n=r.length;return t.col=r[n-1],t.line=r[n-2],r.splice(n-2,2),t.targetUrl=r.join(":"),t}},{key:"catchClickQueue",value:function(){window.addEventListener?"ontouchstart"in document.documentElement?window.addEventListener("touchstart",this._storeClickedDom,!0):window.addEventListener("click",this._storeClickedDom,!0):document.attachEvent("onclick",this._storeClickedDom)}},{key:"catchPerformance",value:function(){window.performance&&a.handleAddListener("load",this._getTiming())}}]),i}(function(e){return function(i){function a(e){t(this,a);var r=o(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e));return r.handlers={},r}return n(a,e),r(a,[{key:"on",value:function(e,t){return this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(handler),this.handlers[e]}},{key:"off",value:function(e){this.handlers[e]&&delete this.handlers[e]}},{key:"trigger",value:function(e,t){var r=this,n=t||[],o=this.handlers[e];return!o||o.every(function(e){return!1!==e.apply(r,n)})}}]),a}()}(function(e){return function(i){function u(e){t(this,u);var r=o(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,e));return r.setItem(),r}return n(u,e),r(u,[{key:"getItem",value:function(e){return d.getItem(e)}},{key:"setItem",value:function(e){var t=this.config;return d.setItem(this.config.errorLSSign,e,t.validTime,t.maxErrorCookieNo),a.stringify(e)}},{key:"clear",value:function(e){d.clear(e)}}]),u}()}(function(e){return function(i){function u(e){t(this,u);var r=o(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,e));return r.errorQueue=[],r.perfQueue=[],r.repeatList={},r.url=r.config.url+"?err_msg=",["log","debug","info","warn","error"].forEach(function(e,t){r[e]=function(n){return r.handleMsg(n,e,t)}}),r}return n(u,e),r(u,[{key:"repeat",value:function(e){var t=e.rowNum||"",r=e.colNum||"",n=e.msg+t+r;return this.repeatList[n]=this.repeatList[n]?this.repeatList[n]+1:1,this.repeatList[n]>this.config.repeat}},{key:"except",value:function(e){var t=this.config.except,r=!1,n=null;if(a.typeDecide(t,"Array"))for(var o=0,i=t.length;o<i;o++)if(n=t[o],a.typeDecide(n,"RegExp")&&n.test(e.msg)||a.typeDecide(n,"Function")&&n(e,e.msg)){r=!0;break}return r}},{key:"request",value:function(e,t){if(this.config.key){var r=new window.Image;r.onload=t,r.src=e+"&key="+this.config.key}else console.warn("please set key in xbossdebug.config.key")}},{key:"report",value:function(e){var t=this,r=this.config.mergeReport;if(0===this.errorQueue.length)return this.url;var n=r?this.errorQueue:[this.errorQueue.shift()];r&&(this.errorQueue=[]);var o=n.map(function(e){return t.setItem(e),a.serializeObj(e)}).join("|"),i=this.url+o;return this.request(i,function(){e&&e.call(t),t.trigger("afterReport")}),i}},{key:"send",value:function(e){var t=this;if(this.trigger("beforeReport")){var r=e||a.noop,n=this.config.mergeReport?this.config.delay:0;setTimeout(function(){t.report(r)},n)}}},{key:"catchError",value:function(e){return!(Math.random()>=this.config.random)&&!this.repeat(e)&&!this.except(e)&&(this.errorQueue.push(e),this.errorQueue)}},{key:"handleMsg",value:function(e,t,r){if(!e)return!1;if(a.typeDecide(e,"Object")&&!e.msg)return!1;a.typeDecide(e,"Error")&&(e={msg:e.message,ext:{stack:e.stack}});var n=a.typeDecide(e,"Object")?e:{msg:e,level:r};return n=a.assignObject(a.getSystemParams(),n),this.catchError(n)&&this.send(),n}},{key:"reportPerformance",value:function(e,t){var r=this;this.trigger("beforeReportPerformance"),e=a.assignObject(a.getSystemParams(),e);var n=a.serializeObj(e),o=this.url+n;this.request(o,function(){t&&t.call(r),r.trigger("afterReportPerformance")})}}]),u}()}((f=u,function(e){function i(e){t(this,i);var r=o(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return r.consoleList={},r.timeoutkey=null,r.proxy(),r}return n(i,f),r(i,[{key:"proxy",value:function(){var e=this.config;e.proxyAll?this.proxyJquery().proxyModules().proxyTimer().proxyConsole():(e.proxyJquery&&this.proxyJquery(),e.proxyModules&&this.proxyModules(),e.proxyTimer&&this.proxyTimer(),e.proxyConsole&&this.proxyConsole())}},{key:"proxyConsole",value:function(){var e=this;return["log","debug","info","warn","error"].forEach(function(t,r){var n=window.console[t];window.console[t]=function(){for(var o=arguments.length,i=Array(o),u=0;u<o;u++)i[u]=arguments[u];e.reportConsole(n,t,r,a.toArray(i))}}),this}},{key:"proxyTimer",value:function(){return window.setTimeout=this.catTimeout(setTimeout),window.setInterval=this.catTimeout(setInterval),this}},{key:"proxyJquery",value:function(e){var t=this,r=e||window.$;if(!r||!r.event)return this;var n=void 0,o=void 0;r.zepto?(n=r.fn.on,o=r.fn.off,r.fn.on=this.makeArgsTry(n),r.fn.off=function(){var e=[];return a.toArray(arguments).forEach(function(t){a.isFunction(t)&&t.tryWrap&&(t=t.tryWrap),e.push(t)}),o.apply(this,e)}):r.fn.jquery&&(n=r.event.add,o=r.event.remove,r.event.add=this.makeArgsTry(n),r.event.remove=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];var i=[];return a.toArray(r).forEach(function(e){a.typeDecide(e,"Function")&&e.tryWrap&&(e=e.tryWrap),i.push(e)}),o.apply(t,i)});var i=r.ajax;return i&&(r.ajax=function(e,n){return n||(n=e,e=void 0),t.makeObjTry(n),e?i.call(r,e,n):i.call(r,n)}),this}},{key:"reportConsole",value:function(e,t,r,n){var o=this;this.on("beforeReport",function(){o.config.mergeReport=!0});var i="";n.forEach(function(e){a.typeDecide(e,"string")?i+=e:a.typeDecide(e,"array")?i+="["+e.join(",")+"]":i+=a.stringify(e)});var u=this.consoleList[t];return(u=u||[]).push(a.assignObject(a.getSystemParams(),{msg:i,level:r,rowNum:"",colNum:"",targetUrl:""})),u.length>10&&(this.errorQueue=this.errorQueue.concat(u),this.send(!0,function(){u=[]})),e.apply(this,n)}},{key:"proxyModules",value:function(){var e=window.require,t=window.define;if(t&&t.amd&&e&&(window.require=this.catArgs(e),a.assignObject(window.require,e),window.define=this.catArgs(t),a.assignObject(window.define,t)),window.seajs&&t){var r=this;window.define=function(){for(var e,n=[],o=0,i=arguments.length;o<i;o++)e=arguments[o],a.isFunction(e)&&((e=r.cat(e)).toString=function(e){return function(){return e.toString()}}(arguments[o])),n.push(e);return t.apply(this,n)},window.seajs.use=this.catArgs(window.seajs.use),a.assignObject(window.define,t)}return this}},{key:"proxyCustomFn",value:function(e){return this.cat(e)}},{key:"proxyCustomObj",value:function(e){return this.makeObjTry(e)}},{key:"cat",value:function(e,t){var r=this;return function(){for(var n=arguments.length,o=Array(n),i=0;i<n;i++)o[i]=arguments[i];try{return t=t||a.toArray(o),e.apply(r,t)}catch(e){var u=a.getErrorInfo(e);if(r.trigger("tryError",[u]),r.error(u),!r.timeoutkey){var c=window.onerror;window.onerror=a.noop,r.timeoutkey=setTimeout(function(){window.onerror=c,r.timeoutkey=null},50)}throw e}}}},{key:"catArgs",value:function(e){var t=this;return function(){for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];var i=[];return a.toArray(n).forEach(function(e){a.isFunction(e)&&(e=t.cat(e)),i.push(e)}),e.apply(window,i)}}},{key:"catTimeout",value:function(e){var t=this;return function(){for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];var i=a.toArray(n),u=i[0],c=i[1];if(a.isString(u))try{u=new Function(u)}catch(e){throw e}var s=i.splice(2);return u=t.cat(u,s.length&&s),e(u,c)}}},{key:"makeArgsTry",value:function(e,t){var r=this;return function(){var n,o=[];return a.toArray(arguments).forEach(function(e){a.isFunction(e)&&(n=r.cat(e))&&(e.tryWrap=n)&&(e=n),o.push(e)}),e.apply(t||this,o)}}},{key:"makeObjTry",value:function(e){var t=void 0,r=void 0;for(t in e)e.hasOwnProperty(t)&&(r=e[t],a.isFunction(r)&&(e[t]=this.cat(r)));return e}}]),i}())))));return window.xbossdebug=new h,xbossdebug});
